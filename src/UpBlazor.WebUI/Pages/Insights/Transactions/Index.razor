@page "/insights/transactions/{AccountId?}"

@using MudBlazor
@using Color = MudBlazor.Color

@inject UpClient UpClient
@if (_loading)
{
    <MudProgressLinear Indeterminate />
}
else
{
    <MudTabPanel Text="Tab One">
        <MudText>Content One</MudText>
    </MudTabPanel>
    
    
    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        @foreach (var account in _accounts)
        {
            <MudTabPanel Text="@account.Attributes.DisplayName">
                @{
                    var transactions = _transactions.Data
                        .Where(x => x.Relationships.Account.Data.Id == account.Id)
                        .ToList();
                }
                <MudDataGrid Items="transactions" Outlined Elevation="0">
                    <Columns>
                        <MudBlazor.Column T="TransactionResource" Title="Created At">
                            <CellTemplate>
                                @context.Item.Attributes.CreatedAt.ToString("f")
                            </CellTemplate>
                        </MudBlazor.Column>
                        <MudBlazor.Column T="TransactionResource" Title="Description">
                            <CellTemplate>
                                @context.Item.Attributes.Description
                            </CellTemplate>
                        </MudBlazor.Column>
                        <MudBlazor.Column T="TransactionResource" Title="Message">
                            <CellTemplate>
                                @context.Item.Attributes.Message
                            </CellTemplate>
                        </MudBlazor.Column>
                        <MudBlazor.Column T="TransactionResource" Title="Amount">
                            <CellTemplate>
                                @if (context.Item.Attributes.Amount.ValueInBaseUnits < 0)
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Error">
                                        $@context.Item.Attributes.Amount.Value[1..]
                                    </MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Success">
                                        $@context.Item.Attributes.Amount.Value
                                    </MudText>
                                }
                            </CellTemplate>
                        </MudBlazor.Column>
                    </Columns>
                </MudDataGrid>
            </MudTabPanel>
        }
    </MudTabs>
    
    <MudButton OnClick="LoadMoreAsync">Load More</MudButton>
}

@code
{
    private bool _loading;
    
    private UpPaginatedViewModelOfTransactionResource _transactions;
    private IReadOnlyList<AccountResource> _accounts;

    [Parameter]
    public string AccountId { get; set; }

    protected override async Task OnInitializedAsync() => await ReloadAsync();

    private async Task ReloadAsync()
    {
        _loading = true;

        if (string.IsNullOrWhiteSpace(AccountId))
        {
            _transactions = await UpClient.GetAllTransactionsAsync();
        }
        else
        {
            _transactions = await UpClient.GetTransactionsAsync(AccountId);
        }

        _accounts = await UpClient.GetAccountsAsync();

        // View only one account
        if (!string.IsNullOrWhiteSpace(AccountId))
        {
            _accounts = _accounts.Where(x => x.Id == AccountId).ToList();
        }

        _loading = false;
    }

    private async Task LoadMoreAsync()
    {
        _transactions = await UpClient.GetTransactionsPaginationLinkAsync(_transactions.Links.Next);
    }
}
