@using MudBlazor
@using Color = MudBlazor.Color

@inject ExpensesClient ExpensesClient
@inject IncomesClient IncomesClient
@inject UpClient UpClient

<MudText Typo="Typo.h4">
    Expenses
</MudText>

<MudDataGrid Items="_expenses" Loading="_loading" >
    <Columns>
        <MudBlazor.Column T="Expense" Field="@nameof(Expense.Name)" CellClass="mud-typography-body1" />
        <MudBlazor.Column T="Expense" Title="Amount">
            <CellTemplate>
                <ExactOrRelativeMoneyDisplay Item="context.Item.Money"/>
            </CellTemplate>
        </MudBlazor.Column>
        <MudBlazor.Column T="Expense" Field="@nameof(Expense.PaidByDate)" Title="Paid By">
            <CellTemplate>
                <DateDisplay Date="context.Item.PaidByDate"/>
            </CellTemplate>
        </MudBlazor.Column>
        <MudBlazor.Column T="Expense" Title="From Saver">
            <CellTemplate>
                <SaverIdColumn SaverId="@context.Item.SaverId" Accounts="_accounts"/>
            </CellTemplate>
        </MudBlazor.Column>
        <MudBlazor.Column T="Expense" Title="From Income">
            <CellTemplate>
                <IncomeIdColumn IncomeId="@context.Item.FromIncomeId" Incomes="_incomes"/>
            </CellTemplate>
        </MudBlazor.Column>
        <MudBlazor.Column T="Expense" >
            <CellTemplate>
                <MudIconButton Icon="@Icons.Rounded.Delete" Color="Color.Tertiary" OnClick="async () => await DeleteAsync(context.Item)"/>
            </CellTemplate>
        </MudBlazor.Column>
    </Columns>
    <NoRecordsContent>
        <MudText Typo="Typo.body1">
            No expenses
        </MudText>
    </NoRecordsContent>
</MudDataGrid>

@code
{
    private bool _loading;

    private IReadOnlyList<Expense> _expenses;
    private IReadOnlyList<Income> _incomes;
    private IReadOnlyList<AccountResource> _accounts;

    protected override async Task OnInitializedAsync() => await ReloadAsync();

    internal async Task ReloadAsync(bool forceReload = false)
    {
        _loading = true;
        
        if (forceReload)
        {
            StateHasChanged();
        }

        _expenses = await ExpensesClient.GetExpensesAsync();
        _incomes = await IncomesClient.GetIncomesAsync();
        _accounts = await UpClient.GetAccountsAsync();

        _loading = false;

        if (forceReload)
        {
            StateHasChanged();
        }
    }
    
    private async Task DeleteAsync(Expense expense)
    {
        _loading = true;

        await ExpensesClient.DeleteExpenseAsync(expense.Id);

        _loading = false;

        await ReloadAsync();
    }
}
